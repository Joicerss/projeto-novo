name: Build and publish Docker image

on:
  workflow_dispatch: {}
  push:
    branches: [ main ]
  pull_request:
    types: [closed]
    branches: [ main ]

jobs:
  build-and-push:
    if: github.event_name != 'pull_request' || github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    env:
      IMAGE: ghcr.io/${{ toLower(github.repository_owner) }}/projeto-novo
    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Debug IMAGE value
        run: |
          echo "Using IMAGE=${{ env.IMAGE }}"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.IMAGE }}:${{ github.sha }}
            ${{ env.IMAGE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  smoke-test:
    needs: build-and-push
    runs-on: ubuntu-latest
    env:
      IMAGE: ghcr.io/${{ toLower(github.repository_owner) }}/projeto-novo
    permissions:
      contents: read
      packages: read

    steps:
      - name: Checkout repo (for sample data)
        uses: actions/checkout@v4

      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create sample data for smoke test
        run: |
          mkdir -p data
          cat > data/sample_test.csv <<'CSV'
          numero_processo,partes,descricao
          0000000-00.0000.0.00.0000,Autor X,"Itau Unibanco cobrou veiculo acidente R$ 12.000,00"
          0000001-11.1111.1.11.1111,Autor Y,"Reclamação sobre veículo: carreta e caminhão envolvidos"
          CSV

      - name: Pull image
        run: |
          IMAGE=${{ env.IMAGE }}:latest
          docker pull $IMAGE

      - name: Run smoke test (execute pipeline inside container)
        run: |
          IMAGE=${{ env.IMAGE }}:latest
          mkdir -p $GITHUB_WORKSPACE/outputs
          docker run --rm \
            -v $GITHUB_WORKSPACE/data:/app/data \
            -v $GITHUB_WORKSPACE/outputs:/app/outputs \
            $IMAGE

      - name: Validate outputs
        run: |
          echo "Checking outputs directory..."
          ls -la outputs || (echo "outputs directory not found" && exit 1)
          
          echo "Checking for consolidado_flags.csv..."
          if [ ! -f outputs/consolidado_flags.csv ]; then
            echo "ERROR: consolidado_flags.csv not produced"
            exit 1
          fi
          
          echo "Checking for consolidado_flags.json..."
          if [ ! -f outputs/consolidado_flags.json ]; then
            echo "ERROR: consolidado_flags.json not produced"
            exit 1
          fi
          
          echo "✓ Smoke test passed: All expected outputs generated"
